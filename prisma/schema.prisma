generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String           @id @default(uuid())
  email                 String           @unique
  password_hash         String
  name                  String
  created_at            DateTime         @default(now())
  files                 Files[]
  folders               Folders[]
  sharedFilesWithUser   Shared_Files[]   @relation("SharedWithUser")
  sharedFilesByUser     Shared_Files[]   @relation("SharedBy")
  sharedFoldersByUser   Shared_Folders[] @relation("FolderSharedBy")
  sharedFoldersWithUser Shared_Folders[] @relation("FolderSharedWith")
}

enum FileStatus {
  UPLOADING
  UPLOADED
  FAILED
  DELETED
}

model Files {
  id            String          @id @default(uuid())
  original_name String
  storage_key   String
  mime_type     String
  size          Int
  uploaded_at   DateTime        @default(now())
  user_id       String
  user          User            @relation(fields: [user_id], references: [id])
  fileVersions  File_Versions[]
  sharedFiles   Shared_Files[]
  fileStatus    FileStatus      @default(UPLOADING)
  folders       Folders?        @relation("FilesWithInFolder", fields: [folder_id], references: [id])
  folder_id     String?
}

model Folders {
  id            String           @id @default(uuid())
  name          String
  created_at    DateTime         @default(now())
  user_id       String
  user          User             @relation(fields: [user_id], references: [id])
  parent_id     String?
  parent        Folders?         @relation("FolderHierarchy", fields: [parent_id], references: [id])
  children      Folders[]        @relation("FolderHierarchy")
  files         Files[]          @relation("FilesWithInFolder")
  is_deleted    Boolean          @default(false)
  sharedFolders Shared_Folders[]
}

model File_Versions {
  id             String   @id @default(uuid())
  file_id        String
  file           Files    @relation(fields: [file_id], references: [id])
  version_number Int
  storage_key    String
  created_at     DateTime @default(now())
}

model Shared_Files {
  id           String   @id @default(uuid())
  file_id      String
  shared_by    String
  shared_with  String
  created_at   DateTime @default(now())
  revoked      Boolean  @default(false)
  file         Files    @relation(fields: [file_id], references: [id])
  sharedByUser User     @relation("SharedBy", fields: [shared_by], references: [id])
  sharedWith   User     @relation("SharedWithUser", fields: [shared_with], references: [id])

  @@unique([file_id, shared_with])
}

model Shared_Folders {
  id          String   @id @default(uuid())
  folder_id   String
  shared_by   String
  shared_with String
  revoked     Boolean  @default(false)
  created_at  DateTime @default(now())

  folder       Folders @relation(fields: [folder_id], references: [id])
  sharedByUser User    @relation("FolderSharedBy", fields: [shared_by], references: [id])
  sharedWith   User    @relation("FolderSharedWith", fields: [shared_with], references: [id])

  @@unique([folder_id, shared_with])
}
